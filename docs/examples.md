# `masha` Usage Examples

The masha command-line utility is designed to simplify the process of generating output files by merging multiple configuration files with Jinja2 templates.

## Example 1 : masha as yasha

The `masha` tool provides a straightforward way to generate output files by merging multiple configuration files with Jinja2 templates. Hereâ€™s a step-by-step guide on how to use the `masha` command-line utility:

### Step 1: Prepare Configuration Files

First, you need to create one or more configuration files that will be used as input. These can be in JSON, YAML, or any other format supported by `masha`. For example, consider two configuration files (`config1.json` and `config2.yaml`) as shown below:

* First configuration file in `json`
`==> config1.json <==`
```json
{
	"key_1": "value_1",
	"key_2": "value_2"
}
```

* Second configuration file in `yaml`
`==> config2.yaml <==`
```yaml
key_1: value_1_overridden
key_3: value_3
```

### Step 2: Create a Jinja2 Template

Next, create a Jinja2 template that uses variables from your configuration files. For example

* Input Jinja2 template file
`==> input.txt.j2 <==`
```j2
key_1 = {{ key_1 }}
key_2 = {{ key_2 }}
key_3 = {{ key_3 }}

```

### Step 3: Generate the Output File

* Output file generated by `yasha`
`==> output-yasha.txt <==`
```sh
yasha -v config1.json -v config2.yaml -o output-yasha.txt input.txt.j2
```
```
key_1 = value_1_overridden
key_2 = value_2
key_3 = value_3
```

* Output file generated by `masha`
`==> output-masha.txt <==`
```sh
masha -v config1.json -v config2.yaml -o output-yasha.txt input.txt.j2
```
```
key_1 = value_1_overridden
key_2 = value_2
key_3 = value_3
```

This demonstrates how to use `masha` to dynamically generate content based on multiple configuration sources.

---

## Example 2 : Resolving Configuration with Environment Variable and Jinja2 Template

### Step 1: Prepare Configuration Files
* First configuration file `user.yaml`, with:
  * env variables `$USER_ID` and `$USER`
  * jinja2 template `{{ name }}`
```yaml
id: ${USER_ID:1000}
name: ${USER:default_user}
email: "{{ name }}@example.com"
address: null
```

* Second configuration file `address.yaml`, with:
  * jinja2 template `{{ Indore }}` to get pincode from `city_pincode.yaml` mapping file.
  * jinja2 template `{{ name | uppercase }}` with filter function `uppercase` from `filter.py` file.
```yaml
street: "c/o {{ name | uppercase }}, ABC street"
city: Indore
pin_code: "{{ Indore }}"
```

* Third configuration file `city_pincode.yaml` holding city to pincode mapping.
```yaml
Indore: 451115
Bangalore: 560068
```

* `filter.py` is having filter function `uppercase`
```py
def uppercase(s: str) -> str:
    """
    Converts the given string to uppercase.

    Args:
        s (str): The input string.

    Returns:
        str: The uppercase version of the input string.
    """
    return s.upper()
```

### Step 2: Create a Jinja2 Template
* Input Jinja2 file to be rendered `input.txt.j2`
```
User Details:
=============
id =  {{ id }}
name = {{ name }}
email =  {{ email }}

Address Details:
================
street =  {{ street }}
city =  {{ city }}
pin_code =  {{ pin_code }}
```

### Step 3: Generate the Output File

* Executing the `masha` command with above specifications, and `USER_ID=502` as environment variable
```sh
$ USER_ID=502 masha -v user.yaml -v address.yaml -v city_pincode.yaml -f $PWD -o output.txt input.txt.j2
2025-02-15 10:10:08,678 INFO    [cli.py              :121:process_template_with_validation] {"id": "502", "name": "miteshjat", "email": "miteshjat@example.com", "address": null, "street": "c/o MITESHJAT, ABC street", "city": "Indore", "pin_code": "451115", "Indore": 451115, "Bangalore": 560068}
2025-02-15 10:10:08,680 INFO    [cli.py              :66: render_jinja_template] Rendered output written to output.txt
2025-02-15 10:10:08,680 INFO    [cli.py              :231:                  main] Command run successfully
```
* Explanation of parameters of above command
    - **Environment Variable**: `USER_ID=502` sets an environment variable that can be used within the template.
    - **Configuration Files**: `-v user.yaml -v address.yaml -v city_pincode.yaml` specifies the configuration files to be merged.
    - **Filter Function Directory**: `-f $PWD` specifies the current directory as the input directory.
    - **Output File**: `-o output.txt` specifies the file where the rendered template will be saved.
    - **Input File**: `input.txt.j2` provides the input text with Jinja2 template.

* Generated `output.txt` file by above `masha` command.
```
User Details:
=============
id =  502
name = miteshjat
email =  miteshjat@example.com

Address Details:
================
street =  c/o MITESHJAT, ABC street
city =  Indore
pin_code =  451115
```

This example demonstrates how `masha` can be used to dynamically generate output files by merging multiple configuration sources and applying them to a Jinja2 template.

---

## Example 3 : Resolving Configuration with Environment Variable and Jinja2 Template with Data Validation

This example demonstrates how masha can be used to manage complex configuration files, apply dynamic data through Jinja2 templates, and ensure data integrity with Pydantic validators. The custom filters and tests provide additional functionality for processing the data before rendering the final output.


### Step 1: Prepare Configuration Files
* First Configuration `User` with out `age` field
`==> user.yaml <==`
```yaml
id: ${USER_ID:1000}
name: ${USER:default_user}
email: "{{ name }}@example.com"
address: null
```

* First Configuration `User` with `age` field
`==> user-with-age.yaml <==`
```yaml
id: ${USER_ID:1000}
name: ${USER:default_user}
email: "{{ name }}@example.com"
address: null
age: 42
```

* Second configuration file for `Address` 
`==> address.yaml <==`
```yaml
address:
  street: "c/o {{ name | uppercase }}, ABC street"
  city: Indore
  pin_code: "{{ Indore }}"
```

* Third configuration file for city to pin_code mapping
`==> city_pincode.yaml <==`
```yaml
Indore: 451115
Bangalore: 560068
```

* Jinja2 Filter functions file
`==> filters/string_utils.py <==`
```py
def uppercase(s: str) -> str:
    """
    Converts the given string to uppercase.

    Args:
        s (str): The input string.

    Returns:
        str: The uppercase version of the input string.
    """
    return s.upper()
```

* Jinja2 Test functions file
`==> tests/math_utils.py <==`
```py
def is_even(number):
    """
    Check if a given number is even.

    Args:
        number (int): The number to check.

    Returns:
        bool: True if the number is even, False otherwise.
    """
    return number % 2 == 0
```

* Validation Classes file `validator_classes.py`
```py
from pydantic import BaseModel, validator

class Address(BaseModel):
    street: str
    city: str
    pin_code: str

class User(BaseModel):
    id: int
    name: str
    email: str
    age: int = None
    address: Address

    @validator('email')
    def validate_email(cls, v):
        if not "@" in v:
            raise ValueError("Invalid email format")
        return v

    @validator('age', always=True)
    def validate_age(cls, v):
        if v is None or v < 0:
            return 0
        return v
```

### Step 2: Create a Jinja2 Template
* Input Jinja2 Template
`==> input.txt.j2 <==`
```j2
User Details:
=============
id =  {{ id }}
name = {{ name }}
email =  {{ email }}
{% if age %}
{% if age is even %}
age = {{ age }} (even)
{% else %}
age = {{ age }} (odd)
{% endif %}
{% endif %}

Address Details:
================
street =  {{ address.street }}
city =  {{ address.city }}
pin_code =  {{ address.pin_code }}
```

### Step 3: Generate the Output File
* Running `masha` command with above specifications and without `age` field.
```sh
$ USER_ID=502 masha -v user.yaml -v address.yaml -v city_pincode.yaml -f filters -t tests -m validator_classes.py -c User  -o output.txt input.txt.j2
2025-02-15 11:08:16,142 INFO    [cli.py              :121:process_template_with_validation] {"id": "502", "name": "miteshjat", "email": "miteshjat@example.com", "address": {"street": "c/o MITESHJAT, ABC street", "city": "Indore", "pin_code": "451115"}, "Indore": 451115, "Bangalore": 560068}
2025-02-15 11:08:16,163 WARNING [config_validator.py :47:       validate_config] Validation failed with errors: 1 validation error for User
age
  Input should be a valid integer [type=int_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/int_type
2025-02-15 11:08:16,163 ERROR   [cli.py              :233:                  main] Command failed with error Given config is invalid <Failure: Validation failed with errors: 1 validation error for User
age
  Input should be a valid integer [type=int_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.10/v/int_type>
```
* Running `masha` command with above specifications and `age` field.
```sh
$ USER_ID=502 masha -v user-with-age.yaml -v address.yaml -v city_pincode.yaml -f filters -t tests -m validator_classes.py -c User  -o output.txt input.txt.j2
2025-02-15 11:07:49,893 INFO    [cli.py              :121:process_template_with_validation] {"id": "502", "name": "miteshjat", "email": "miteshjat@example.com", "address": {"street": "c/o MITESHJAT, ABC street", "city": "Indore", "pin_code": "451115"}, "age": 42, "Indore": 451115, "Bangalore": 560068}
2025-02-15 11:07:49,915 INFO    [cli.py              :66: render_jinja_template] Rendered output written to output.txt
2025-02-15 11:07:49,915 INFO    [cli.py              :231:                  main] Command run successfully
```
* Output when `user-with-age.yaml` is used with `masha`
`==> output.txt <==`
```
User Details:
=============
id =  502
name = miteshjat
email =  miteshjat@example.com


age = 42 (even)



Address Details:
================
street =  c/o MITESHJAT, ABC street
city =  Indore
pin_code =  451115
```
